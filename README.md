
# SCRIPT Microbiology Whole-Genome Sequencing Pipeline

## Prerequisites

**1.**  [Conda](https://conda.io/projects/conda/en/latest/user-guide/install/index.html) or [Mamba (recommended)](https://mamba.readthedocs.io/en/latest/installation.html)

* NOTE: On Quest you can use the mamba module: `module load mamba/0.15.3` 

**2.** [Snakemake](https://snakemake.readthedocs.io/): 

* NOTE: The only Snakemake module currently on Quest is pretty old (v6.1.2). You'll need to use a newer version of Snakemake to run this pipeline (I have v7.24.2). You can follow these instructions to install:

```
mamba create -c conda-forge -c bioconda -n snakemake snakemake
```

**3.** [Singularity](https://docs.sylabs.io/guides/3.8/user-guide/quick_start.html#quick-installation-steps): required for the fcs_adaptor step. If you are running this on Quest you do not need to install separately; it will be loaded as a module. 


## Installation  

Download the directory and files from github:

```
git clone https://github.com/egonozer/script_micro_wgs
cd script_micro_wgs
gunzip ref/PA_subelements.txt
```

Download the support software  
  
  * Be aware that the minikraken database is 8GB in size and fcs-adaptor.sif (v0.4.0) is momre than 300 MB. These could take a while to download. If you have already downloaded these you can comment those lines in the *install_dependencies.sh* and modify the config.yaml file to point to the existing files.   
  
```
bash install_dependencies.sh
```

If running on Quest, modify the quest/config.yaml file:

1. Change the `default-resources` to the account, partition, and email address you'd like to use


## Analysis

**1.** Create the sample sheet:

* Either modify the example *samples.tsv* file or create your own tab-separated-file
* First line of the file must have the headers `sample read1 read2` separated by tabs
* Fill in the rest of the file, one line per sample, with the sample id in the first column and full paths to first and second reads in the second and third columns 

**2.** Modify the *config.yaml* file in the *script_micro_wgs* directory

* Give the full path to the *samples.tsv* file for the `samples` variable. For example:  
   `samples: "/path/to/samples.tsv"`  
* Set the path to the output directory for the `outdir` variable. **WARNING:** This directory must already exist. Example:  
    `outdir: "/path/to/wgs_output"`

**3.** Run the analysis:

* If you are not using Quest (set `--cores` to the maximum number of cores on your system you would like to use):  
`snakemake --cores 12`
* If you are using Quest:  

```
conda activate snakemake
snakemake --profile quest
```  

If running many analyses, you may want to run snakemakke using `screen` or `nohup` in case you accidentally disconnect or you don't want to stay connected to wait for the results:  
`nohup snakemake --profile quest &`

## Results 
Results will be locaed in a directory titled **results** within your designated output directory. This directory will contain several other directories as well as a report of assembly and alignment stats in a file called **multiqc_report.html**.  

| Directory | Description |  
|:----------:|------------|
|*agent* | Accessory genome sequences |
|*checkpoints*| Checkpoint files generated by the pipeline. Can be ignored or deleted.|
|*clustage*| Clustered accessory genome sequences. Clustering is against reference accessory element set given in config.yaml|
|*final_assembles*| Filtered assembly contig files |
|*fastqc*| Sequencing read quality control|
|*kraken*| Genus and species assignment |
|*mlst* | MLST allele and sequence type assignment |
|*multiqc_data* | Multiqc program data outputs |
|*prokka* | Annotated genome sequence | 
|*snippy* | Reference alignmenet and variant calls | 
|*spades* | Genome assembly |
|*spades_filtered* | Assembly contig quality filtering results |
|*trimmed_reads* | Sequencing reads after quality trimming | 

